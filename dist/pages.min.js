/*
Comecero Data Exporter version: 0.9.1
https://comecero.com
https://github.com/comecero/data-exporter
Copyright Comecero and other contributors. Released under MIT license. See LICENSE for details.
*/

app.controller("SettingsController",function(e,a){e.settings=a.get()}),app.controller("TimezonesController",function(e,a){e.timezones=a.getTimezones()}),app.controller("RootController",function(e,a,t,r){e.options={dataset:"orders",format:"csv",timezone:"UTC",dates:"last_30",unravelFields:[{id:"items",name:"Items"}],unravelField:"items"},e.datepicker={status:{date_start:{opened:!1},date_end:{opened:!1}},options:{startingDay:1,showWeeks:!1,initDate:new Date,yearRange:10},open:function(a,t){e.datepicker.status[t].opened=!0}};var n=function(a,t){var n={date_start:e.options.dates,date_end:e.options.dates,timezone:a.timezone};switch(e.options.dates){case"last_30":n.date_start=-29,n.date_end=0;break;case"last_7":n.date_start=-6,n.date_end=0;break;case"custom":t.date_end||(t.date_end=new Date),e.datepicker.date_start||(t.date_start=e.datepicker.date_end),n.date_start=t.date_start.toISOString().substring(0,10),n.date_end=t.date_end.toISOString().substring(0,10)}return"/"+a.dataset+"?"+r(n)},s=function(e,a,t){if(null!=t&&navigator.msSaveBlob)return navigator.msSaveBlob(new Blob([t],{type:a}),e);var r=angular.element("<a style='display: none;'/>"),n=window.URL.createObjectURL(new Blob([t],{type:a}));r.attr("href",n),r.attr("download",e);var s=angular.element(document).find("body").eq(0);s.append(r),r[0].click(),window.URL.revokeObjectURL(n),r.remove()},o=function(){return!!angular.isFunction(e.cancelFunc)&&(e.cancelFunc(),e.cancelFunc=void 0,!0)},i=function(r,s){var i=t.defer(),c=n(r,s),u=[];return e.cancelFunc=e.$watch(function(){return c},function(e){angular.isUndefined(e)||null==e||a.getList(e).then(function(e){var a=e.data,t=a.next_page_url;if(angular.isArray(a.data))for(var r in a.data)u.push(a.data[r]);return angular.isUndefined(t)||null==t?(i.resolve(u),void o()):void(c=t)},function(e){o(),reject(e)})}),i.promise},c=function(e){if(!angular.isArray(e)&&angular.isObject(e)){var a=Object.keys(e);for(var t in a){var r=a[t];c(e[r])}var n=Object.keys(e);for(var s in n){var o=n[s],i=e[o];if(!angular.isArray(i)&&angular.isObject(i)){var u=Object.keys(i);for(var d in u){var l=u[d],v=i[l];e[o+"."+l]=v}delete e[o]}}}},u=function(e,a){var t=[];for(var r in e){var n=angular.copy(e[r]);if(angular.isDefined(a.unravelField)&&angular.isArray(n[a.unravelField])){var s=n[a.unravelField];delete n[a.unravelField];for(var o in s){var i=angular.copy(s[o]),u=Object.keys(i);for(var d in u){var l=u[d],v=i[l];delete i[l],i[a.unravelField+"."+l]=v}t.push(angular.merge(i,n))}}else t.push(n)}for(var r in t)c(t[r]);for(var r in t){var n=t[r],u=Object.keys(n);for(var o in Object.keys(n)){var l=u[o];angular.isArray(n[l])||l.match(/object$/)?delete n[l]:angular.isString(n[l])&&n[l].match(/\/api\/v1\//)&&delete n[l]}}return Papa.unparse(t)},d=function(a,t){i(a,t).then(function(r){if(!angular.isArray(r)||r.length<=0)return void(e.error={message:"No results found"});var n,o="text/"+a.format;switch(a.format){case"csv":n=u(r,a);break;case"json":n=JSON.stringify(r,function(e,a){return a},new Number(2));break;default:return void(e.error={message:"Unknown export format"})}var i=a.dates;"custom"==i&&(i=t.date_start.toISOString().substring(0,10)+"_to_"+t.date_end.toISOString().substring(0,10));var c=a.dataset+"_"+i+"."+a.format;s(c,o,n),e.successMessage="Export successful"},function(a){e.error=a,o()})};e.export=function(){e.clearMessages(),d(angular.copy(e.options),angular.copy(e.datepicker))},e.cancel=function(){o()&&(e.successMessage="Canceled export.")},e.clearMessages=function(){e.successMessage="",e.error={}}});